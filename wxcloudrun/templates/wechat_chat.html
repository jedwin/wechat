<!DOCTYPE html>
{% load static %}
<html lang="zh-cmn-Hans" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <meta name="wechat-enable-text-zoom-em" content="true">
    <meta name="color-scheme" content="light dark">
    <title>GPT and encryption</title>
    <link rel="stylesheet" href="{% static 'style/weui.css' %}"/>
</head>
<body >
    
    <div id="container">
        <div type="text/html" id="tpl_home">
            <div class="page article">
                <article class="weui-article">
                    <section style="margin-bottom: 8px;">
                        <p style="text-align: center;">
                            <H1>NPC应答测试</H1>
                        </p>
                    </section>
                    <section>
                        {{ reply_obj | safe}}
                    </section>
                    <section id='encrypted_msg'>
                        {{ encrypted_msg }}
                    </section>
                    <section id='tag'>
                        {{ encrypted_tag }}
                    </section>
                </article>
            </div>
            
            <div class="weui-form">
                <form class="weui-cells__group weui-cells__group_form" action="/chat/" method="post" id="form_question" >
                    {% csrf_token %}
                    <input type="hidden" name="character" value="" id="character">
                    <input type="hidden" name="encrypted_key" value="">
                    <input type="hidden" name="encrypted_iv" value="">
                    <div style="display: none;" id="public_key">
                    -----BEGIN PUBLIC KEY-----
                    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjAc3qeZQYE7HdHATK5YI
                    iMG/fgHhriyNApm6B/RB6Pn5BlcWQDAYwVXx4CeaQ/xzuzlUmbPzHRe+F01zN6Rk
                    zGiVN/cotQAFzCajwaZc8iiKM1mwuzZbNmPa/+ebdAAsHr6eAXoRTy1aEhOUarzZ
                    Mn2ylGhx1VhZg+ecQkEQafWUwvk/7M+1hfjn3BLdwyJ2O8FIGICY3KnfLd9GOJCq
                    k1n10gBiQYYXrPtvJIljhYYFGpl5hDvm7BH3+wOKsuljsADBJwPF6XQzbMAL1ifw
                    nb06hUElvXtrlRmWxaGWTwIhdrFqCPLiXyUqXN0tFnARNsAL3FmtqpXefBl/GkZg
                    BwIDAQAB
                    -----END PUBLIC KEY-----
                    </div>
                    <div class="weui-cells__group weui-cells__group_form">
                        <div class="weui-cells weui-cells_radio">
                            {% for npc in characters %}
                                <label class="weui-cell weui-cell_active weui-check__label" for="{{npc}}">
                                    <div class="weui-cell__bd">
                                        <p>{{npc}}</p>
                                    </div>
                                    <div class="weui-cell__ft">
                                        
                                        {% if npc == chosen_character %}
                                        <input type="radio" class="weui-check" name="radio1" id="{{npc}}" checked>
                                        {% else %}
                                        <input type="radio" class="weui-check" name="radio1" id="{{npc}}">
                                        {% endif %}
                                        <span class="weui-icon-checked"></span>
                                    </div>
                                </label>
                            {% endfor %}
                            
                        </div>
                    </div>

                    <div class="weui-cells">
                        
                        <label for="question" class="weui-cell weui-cell_active">
                            
                            <div class="weui-cell__bd">
                                
                                    <input id="question" class="weui-input" placeholder="你想问什么问题？" name="question"/>
                                
                            </div>
                        </label>
                        <label for="encrypted_msg" class="weui-cell weui-cell_active">
                            
                            <div class="weui-cell__bd">
                                
                                    <input id="encrypted_msg" class="weui-input" placeholder="Enrypt Message" name="encrypted_msg"/>
                                
                            </div>
                        </label>
                        <br>
                        <hr>
                        <br>
                        <div class="weui-form__opr-area">
                            <a role="button" disabled aria-disabled="true" href="javascript:" id="confirm_button"
                            class="weui-btn weui-btn_primary weui-btn_disabled">确定</a>
                        </div>
                        <br>
                        <hr>
                        <br>
                        <div class="weui-form__opr-area">
                            <a role="button" href="javascript:" id="encrypt_button"
                            class="weui-btn weui-btn_primary">加密发送</a>
                        </div>
                        <br>
                        <hr>
                        <br>
                        <div class="weui-form__opr-area">
                            <a role="button" href="javascript:" id="decrypt_button"
                            class="weui-btn weui-btn_primary">解密</a>
                        </div>  
                </form>
            </div>
            <div class="weui-footer weui-footer_fixed-bottom">
                <p class="weui-footer__text">{{summary|safe}}</p>
            </div>
        </div> 
    </div>

    <script src="{% static 'js/jsencrypt.min.js' %}"></script>
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/common.js' %}"></script>
    <script type="text/javascript" for="encrypt_decrypt">
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            var binary_string = window.atob(base64);
            var len = binary_string.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        async function generateKey() {
            return window.crypto.subtle.generateKey(
                {
                    name: "AES-GCM",
                    length: 256, // 可以是 128, 192, 或 256
                },
                true, // 是否可提取
                ["encrypt", "decrypt"] // 使用密钥的用途
            );
        }
        
        async function encryptData(key, data) {
            const encodedData = new TextEncoder().encode(data);
        
            // AES-GCM 需要一个 IV（初始化向量）
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
        
            const encryptedData = await window.crypto.subtle.encrypt(
                {
                    name: "AES-GCM",
                    iv: iv
                },
                key,
                encodedData
            );
        
            return {
                encryptedData: encryptedData,
                iv: iv
            };
        }
        
        async function decryptData(encryptedData, key, iv, tag) {
            const alg = { name: "AES-GCM", iv: iv, tagLength: 96 };
            const decryptedData = await window.crypto.subtle.decrypt(
                alg,
                key,
                new Uint8Array([...new Uint8Array(encryptedData), ...new Uint8Array(tag)])
            );
            return new TextDecoder().decode(decryptedData);
        }
        async function exportKeyToJWK(key) {
            const jwk = await window.crypto.subtle.exportKey("jwk", key);
            return jwk;
        }
        
        async function getKeyAsString(key) {
            const jwk = await exportKeyToJWK(key);
            return JSON.stringify(jwk);
        }
        
        async function importKeyFromJWK(jwkStr) {
            const jwk = JSON.parse(jwkStr);
        
            const key = await window.crypto.subtle.importKey(
                "jwk", // 密钥格式
                jwk, // JWK对象
                {   // 加密算法的详情
                    name: "AES-GCM", // 根据JWK中的alg字段确定算法
                    // 其他算法特定的参数（如长度等）可以在这里指定
                },
                true, // 是否可导出
                jwk.key_ops // 密钥操作数组，如["encrypt", "decrypt"]
            );
        
            return key;
        }
        async function encrypt_msg_and_fillform(){
            var $question = document.getElementById('question');
            var $form = document.getElementById('form_question');
            var public_key = document.getElementById('public_key');
            if (public_key == undefined){
                alert('公钥获取失败');
                return;
            }else{
                public_key = public_key.innerText;
            }
            var encrypt = new JSEncrypt();
            encrypt.setPublicKey(public_key);
            var json_key = sessionStorage.getItem('Key');
            if (json_key == undefined){
                // generate a new key with AES-GCM, and save it to sessionStorage
                var key = await generateKey();
                json_key = await getKeyAsString(key)
                sessionStorage.setItem('Key', json_key);

            }else{
                key = await importKeyFromJWK(json_key, 'AES-GCM', ['encrypt', 'decrypt'])

            }
            var encrypted_key = await encrypt.encrypt(json_key);
            var {encryptedData, iv} = await encryptData(key, $question.value);
            // change encrypted_msg and iv to Base64
            encrypted_msg = arrayBufferToBase64(encryptedData);
            iv = arrayBufferToBase64(iv);
            sessionStorage.setItem('iv', iv);
            var encrypted_iv = await encrypt.encrypt(iv);
            $form.encrypted_key.value = encrypted_key;
            $form.encrypted_iv.value = encrypted_iv;
            $form.encrypted_msg.value = encrypted_msg;
            $question.value = '';
            $form.submit();
        }

        async function decrypt_msg(){
            var $form = document.getElementById('form_question');
            var $encrypted_msg = document.getElementById('encrypted_msg');
            var $tag = document.getElementById('tag');
            var json_key = sessionStorage.getItem('Key');
            if (json_key == undefined){
                alert('密钥获取失败');
                return;
            }
            var key = await importKeyFromJWK(json_key)
            var iv = base64ToArrayBuffer(sessionStorage.getItem('iv'));
            var tag = $tag.innerText;
            var encrypted_msg = $encrypted_msg.innerText;
            await decryptData(encrypted_msg, key, iv, tag)
                .then(function(decrypted_msg){
                    $form.question.value = '解密成功：' + decrypted_msg;
                })
                .catch(function(err){
                    $form.question.value = '解密失败：' + err;
                });
        }

        var $encrypt_button = document.getElementById('encrypt_button');       
        $encrypt_button.addEventListener('click', encrypt_msg_and_fillform);
        
        var $decrypt_button = document.getElementById('decrypt_button');
        $decrypt_button.addEventListener('click', decrypt_msg);
        
        
    </script>
    <script type="text/javascript" for="ask_question">
        var $input = document.getElementById('question');
        var $button = document.getElementById('confirm_button');
        var $character = document.getElementById('character');
        var $labels = document.querySelectorAll('.weui-check__label');
        const Http = new XMLHttpRequest();

        $button.addEventListener('click', function(){
            var answer = $input.value;
            var checked_span = document.querySelector('.weui-check:checked');
            if (checked_span == undefined){
                alert('请选择NPC');
                return;
            }else{
                var checked_label = checked_span.parentNode.parentNode.querySelector('p').innerText;
                $character.value = checked_label;
            }
            if (answer.length == 0){
                return;
            }else{
                // var url = '/chat/?question='+answer+'&character='+checked_label;
                var my_form = document.getElementById('form_question');
                //my_form.character.value = checked_label;
                //my_form.question.value = answer;
                my_form.submit();
                //alert(url);
                //globalThis.location=url;
                
            };
        });
        $input.addEventListener('input', function(){
            var answer = $input.value;
            if (answer.length == 0){
                $button.setAttribute('disabled', true);
                $button.classList.add('weui-btn_disabled');
                $button.setAttribute('aria-disabled','true');
            }else{
                $button.removeAttribute('disabled');
                $button.classList.remove('weui-btn_disabled');
                $button.setAttribute('aria-disabled','false');
            }; 
        });

    </script>

    <script type="text/javascript" src="{% static 'js/jweixin-1.4.0.js' %}"></script>
    <script src="{% static 'js/weui.min.js' %}"></script>
    <script src="{% static 'js/wah.js' %}"></script>
</body>
</html>